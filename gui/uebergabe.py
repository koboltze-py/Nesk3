"""
Ãœbergabe-Widget
Erstellt und verwaltet Tagdienst- und Nachtdienst-Ãœbergabeprotokolle
"""
import os
import sys
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from datetime import date, datetime

from PySide6.QtWidgets import (
    QWidget, QVBoxLayout, QHBoxLayout, QLabel, QPushButton,
    QFrame, QScrollArea, QSplitter, QTextEdit, QLineEdit,
    QSpinBox, QComboBox, QFormLayout, QMessageBox, QSizePolicy,
    QDateEdit, QDialog, QDialogButtonBox, QListWidget, QFileDialog
)
from PySide6.QtCore import Qt, QDate
from PySide6.QtGui import QFont, QColor

from config import (
    FIORI_BLUE, FIORI_TEXT, FIORI_WHITE, FIORI_BORDER,
    FIORI_SUCCESS, FIORI_ERROR, FIORI_SIDEBAR_BG
)
from functions.uebergabe_functions import (
    erstelle_protokoll, aktualisiere_protokoll,
    lade_protokolle, lade_protokoll_by_id, loesche_protokoll,
    schliesse_protokoll_ab,
    speichere_fahrzeug_notizen, lade_fahrzeug_notizen,
    speichere_handy_eintraege, lade_handy_eintraege,
)
from functions.fahrzeug_functions import (
    lade_alle_fahrzeuge,
    lade_termine as lade_fahrzeug_termine,
    aktueller_status as aktueller_fahrzeug_status,
    lade_schaeden_letzte_tage,
    markiere_schaden_gesendet,
)

# â”€â”€ Farben â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
_TAG_COLOR    = "#e67e22"   # Orange fÃ¼r Tagdienst
_NACHT_COLOR  = "#2c3e50"   # Dunkelblau fÃ¼r Nachtdienst
_OFFEN_BG     = "#fff8e1"
_ABGES_BG     = "#e8f5e9"


class _ProtokolListItem(QFrame):
    """Kompaktes Listenelement fÃ¼r ein Protokoll in der Seitenleiste."""

    def __init__(self, protokoll: dict, parent=None):
        super().__init__(parent)
        self._id = protokoll["id"]
        self._setup(protokoll)

    def _setup(self, p: dict):
        typ     = p.get("schicht_typ", "tagdienst")
        datum   = p.get("datum", "")
        status  = p.get("status", "offen")
        erstell = p.get("ersteller", "â€“")

        # Datum lesbar formatieren
        try:
            d = datetime.strptime(datum, "%Y-%m-%d")
            datum_str = d.strftime("%d.%m.%Y")
        except Exception:
            datum_str = datum

        self._farbe  = _TAG_COLOR if typ == "tagdienst" else _NACHT_COLOR
        farbe  = self._farbe
        symbol = "â˜€" if typ == "tagdienst" else "ğŸŒ™"
        label  = "Tagdienst" if typ == "tagdienst" else "Nachtdienst"
        self._bg_base = _OFFEN_BG if status == "offen" else _ABGES_BG

        self._apply_style(False)
        self.setCursor(Qt.CursorShape.PointingHandCursor)
        self.setMinimumHeight(62)

        layout = QVBoxLayout(self)
        layout.setContentsMargins(10, 6, 10, 6)
        layout.setSpacing(2)

        top = QHBoxLayout()
        typ_lbl = QLabel(f"{symbol} {label}")
        typ_lbl.setFont(QFont("Arial", 10, QFont.Weight.Bold))
        typ_lbl.setStyleSheet(f"color: {farbe}; border: none;")

        stat_lbl = QLabel("âœ“ abgeschlossen" if status == "abgeschlossen" else "Â· offen")
        stat_lbl.setFont(QFont("Arial", 9))
        stat_lbl.setStyleSheet(
            f"color: {FIORI_SUCCESS}; border: none;"
            if status == "abgeschlossen"
            else "color: #999; border: none;"
        )
        top.addWidget(typ_lbl)
        top.addStretch()
        top.addWidget(stat_lbl)

        datum_lbl = QLabel(f"ğŸ“… {datum_str}  |  ğŸ‘¤ {erstell}")
        datum_lbl.setFont(QFont("Arial", 9))
        datum_lbl.setStyleSheet("color: #555; border: none;")

        layout.addLayout(top)
        layout.addWidget(datum_lbl)

        # Suchtext fÃ¼r Filterung
        self._search_text = f"{datum_str} {datum} {erstell} {label} {typ} {status}"

    def _apply_style(self, active: bool):
        if active:
            self.setStyleSheet(f"""
                QFrame {{
                    background-color: #cfe0f5;
                    border: 2px solid {self._farbe};
                    border-left: 6px solid {self._farbe};
                    border-radius: 4px;
                }}
            """)
        else:
            self.setStyleSheet(f"""
                QFrame {{
                    background-color: {self._bg_base};
                    border: 1px solid #ddd;
                    border-left: 4px solid {self._farbe};
                    border-radius: 4px;
                }}
            """)

    def set_active(self, active: bool):
        self._apply_style(active)

    @property
    def protokoll_id(self) -> int:
        return self._id


class UebergabeWidget(QWidget):
    """Haupt-Widget fÃ¼r Tagdienst- und Nachtdienst-Ãœbergabeprotokolle."""

    def __init__(self, parent=None):
        super().__init__(parent)
        self._aktives_protokoll_id: int | None = None
        self._ist_neu = False
        self._aktueller_typ = "tagdienst"
        self._list_items: dict[int, "_ProtokolListItem"] = {}
        _today = date.today()
        self._nav_jahr  = _today.year
        self._nav_monat = _today.month
        self._fahrzeug_notiz_widgets: dict = {}
        self._handy_eintraege_widgets: list = []  # list of (nr_edit, notiz_edit)
        self._build_ui()
        self.refresh()

    # â”€â”€ UI-Aufbau â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    def _build_ui(self):
        root = QVBoxLayout(self)
        root.setContentsMargins(0, 0, 0, 0)
        root.setSpacing(0)

        # Header
        root.addWidget(self._build_header())

        # Hauptbereich: Liste | Formular
        splitter = QSplitter(Qt.Orientation.Horizontal)
        splitter.setHandleWidth(2)

        splitter.addWidget(self._build_liste())
        splitter.addWidget(self._build_formular())
        splitter.setSizes([300, 700])

        root.addWidget(splitter, 1)

    def _build_header(self) -> QWidget:
        header = QFrame()
        header.setStyleSheet(f"background-color: {FIORI_SIDEBAR_BG};")
        header.setFixedHeight(64)

        layout = QHBoxLayout(header)
        layout.setContentsMargins(20, 8, 20, 8)
        layout.setSpacing(12)

        title = QLabel("ğŸ“‹ Ãœbergabeprotokolle")
        title.setFont(QFont("Arial", 17, QFont.Weight.Bold))
        title.setStyleSheet("color: white;")
        layout.addWidget(title)
        layout.addStretch()

        # Aktualisieren
        btn_refresh = QPushButton("ğŸ”„ Aktualisieren")
        btn_refresh.setFont(QFont("Arial", 10))
        btn_refresh.setFixedHeight(36)
        btn_refresh.setCursor(Qt.CursorShape.PointingHandCursor)
        btn_refresh.setStyleSheet(
            "QPushButton{background:#fff;color:#333;border:1px solid #ccc;"
            "border-radius:4px;padding:2px 14px;font-weight:bold;}"
            "QPushButton:hover{background:#e8eaf0;}"
        )
        btn_refresh.clicked.connect(self.refresh)
        layout.addWidget(btn_refresh)

        # Neues Tagdienst-Protokoll
        btn_tag = QPushButton("â˜€  Neues Tagdienst-Protokoll")
        btn_tag.setFont(QFont("Arial", 11))
        btn_tag.setFixedHeight(40)
        btn_tag.setCursor(Qt.CursorShape.PointingHandCursor)
        btn_tag.setStyleSheet(f"""
            QPushButton {{
                background-color: {_TAG_COLOR};
                color: white;
                border: none;
                border-radius: 4px;
                padding: 4px 18px;
                font-weight: bold;
            }}
            QPushButton:hover {{ background-color: #e08010; }}
        """)
        btn_tag.clicked.connect(lambda: self._neues_protokoll("tagdienst"))

        # Neues Nachtdienst-Protokoll
        btn_nacht = QPushButton("ğŸŒ™  Neues Nachtdienst-Protokoll")
        btn_nacht.setFont(QFont("Arial", 11))
        btn_nacht.setFixedHeight(40)
        btn_nacht.setCursor(Qt.CursorShape.PointingHandCursor)
        btn_nacht.setStyleSheet(f"""
            QPushButton {{
                background-color: {_NACHT_COLOR};
                color: white;
                border: none;
                border-radius: 4px;
                padding: 4px 18px;
                font-weight: bold;
            }}
            QPushButton:hover {{ background-color: #3d566e; }}
        """)
        btn_nacht.clicked.connect(lambda: self._neues_protokoll("nachtdienst"))

        layout.addWidget(btn_tag)
        layout.addWidget(btn_nacht)
        return header

    def _build_liste(self) -> QWidget:
        container = QWidget()
        container.setMinimumWidth(260)
        container.setMaximumWidth(360)
        layout = QVBoxLayout(container)
        layout.setContentsMargins(0, 0, 0, 0)
        layout.setSpacing(0)

        # Monats-Navigation
        nav_bar = QFrame()
        nav_bar.setStyleSheet("background-color: #e8eaf0; border-bottom: 1px solid #c5c8d4;")
        nav_bar.setFixedHeight(40)
        nl = QHBoxLayout(nav_bar)
        nl.setContentsMargins(6, 4, 6, 4)
        nl.setSpacing(4)
        self._btn_nav_prev = QPushButton("â—„")
        self._btn_nav_prev.setFixedSize(28, 28)
        self._btn_nav_prev.setStyleSheet(
            "QPushButton{background:#fff;border:1px solid #bbb;border-radius:4px;font-size:11px;}"
            "QPushButton:hover{background:#d0d4e8;}"
        )
        self._btn_nav_prev.clicked.connect(self._nav_prev_monat)
        self._lbl_nav_monat = QLabel()
        self._lbl_nav_monat.setAlignment(Qt.AlignmentFlag.AlignCenter)
        self._lbl_nav_monat.setFont(QFont("Arial", 10, QFont.Weight.Bold))
        self._lbl_nav_monat.setStyleSheet("border: none; color: #333;")
        self._btn_nav_next = QPushButton("â–º")
        self._btn_nav_next.setFixedSize(28, 28)
        self._btn_nav_next.setStyleSheet(
            "QPushButton{background:#fff;border:1px solid #bbb;border-radius:4px;font-size:11px;}"
            "QPushButton:hover{background:#d0d4e8;}"
        )
        self._btn_nav_next.clicked.connect(self._nav_next_monat)
        nl.addWidget(self._btn_nav_prev)
        nl.addWidget(self._lbl_nav_monat, 1)
        nl.addWidget(self._btn_nav_next)
        layout.addWidget(nav_bar)

        # Filter-Leiste
        filter_bar = QFrame()
        filter_bar.setStyleSheet("background-color: #f0f2f4; border-bottom: 1px solid #ddd;")
        filter_bar.setFixedHeight(44)
        fl = QHBoxLayout(filter_bar)
        fl.setContentsMargins(8, 4, 8, 4)

        self._filter_combo = QComboBox()
        self._filter_combo.addItems(["Alle", "Tagdienst", "Nachtdienst"])
        self._filter_combo.setStyleSheet("background: white; border: 1px solid #ccc; border-radius: 3px; padding: 2px 6px;")
        self._filter_combo.currentIndexChanged.connect(self._lade_liste)
        fl.addWidget(QLabel("Anzeigen:"))
        fl.addWidget(self._filter_combo, 1)
        layout.addWidget(filter_bar)

        # Suchleiste
        suche_bar = QFrame()
        suche_bar.setStyleSheet("background: #f8f9fb; border-bottom: 1px solid #ddd;")
        suche_bar.setFixedHeight(40)
        sl = QHBoxLayout(suche_bar)
        sl.setContentsMargins(8, 4, 8, 4)
        sl.setSpacing(6)
        suche_icon = QLabel("ğŸ”")
        suche_icon.setStyleSheet("border:none; font-size:13px;")
        self._ue_search = QLineEdit()
        self._ue_search.setPlaceholderText("Datum, Ersteller, Typ ...")
        self._ue_search.setStyleSheet(
            "background:white; border:1px solid #ccc; border-radius:3px;"
            "padding:3px 8px; font-size:11px;"
        )
        self._ue_search.textChanged.connect(self._apply_protokoll_filter)
        sl.addWidget(suche_icon)
        sl.addWidget(self._ue_search, 1)
        layout.addWidget(suche_bar)

        # Scrollbare Liste
        scroll = QScrollArea()
        scroll.setWidgetResizable(True)
        scroll.setHorizontalScrollBarPolicy(Qt.ScrollBarPolicy.ScrollBarAlwaysOff)
        scroll.setStyleSheet("QScrollArea { border: none; }")

        self._liste_container = QWidget()
        self._liste_layout = QVBoxLayout(self._liste_container)
        self._liste_layout.setContentsMargins(8, 8, 8, 8)
        self._liste_layout.setSpacing(4)
        self._liste_layout.addStretch()

        scroll.setWidget(self._liste_container)
        layout.addWidget(scroll, 1)
        return container

    def _build_formular(self) -> QWidget:
        self._form_container = QWidget()
        self._form_container.setStyleSheet("background-color: white;")
        outer = QVBoxLayout(self._form_container)
        outer.setContentsMargins(0, 0, 0, 0)

        # Formular-Header
        self._form_header = QFrame()
        self._form_header.setFixedHeight(50)
        self._form_header.setStyleSheet(f"background-color: #eef4fa; border-bottom: 1px solid {FIORI_BORDER};")
        fhl = QHBoxLayout(self._form_header)
        fhl.setContentsMargins(20, 0, 20, 0)
        self._form_titel = QLabel("Protokoll auswÃ¤hlen oder neu erstellen")
        self._form_titel.setFont(QFont("Arial", 13, QFont.Weight.Bold))
        self._form_titel.setStyleSheet(f"color: {FIORI_TEXT};")
        fhl.addWidget(self._form_titel)
        fhl.addStretch()
        outer.addWidget(self._form_header)

        # Formular-Scroll-Bereich
        scroll = QScrollArea()
        scroll.setWidgetResizable(True)
        scroll.setStyleSheet("QScrollArea { border: none; }")

        form_widget = QWidget()
        form_widget.setStyleSheet("background-color: white;")
        layout = QVBoxLayout(form_widget)
        layout.setContentsMargins(24, 20, 24, 20)
        layout.setSpacing(12)

        # FormLayout fÃ¼r Felder
        fl = QFormLayout()
        fl.setLabelAlignment(Qt.AlignmentFlag.AlignRight)
        fl.setSpacing(10)

        # Datum
        self._f_datum = QDateEdit()
        self._f_datum.setCalendarPopup(True)
        self._f_datum.setDate(QDate.currentDate())
        self._f_datum.setDisplayFormat("dd.MM.yyyy")
        self._f_datum.setStyleSheet(self._field_style())
        fl.addRow("Datum:", self._f_datum)

        # Beginn
        self._f_beginn = QLineEdit()
        self._f_beginn.setPlaceholderText("z.B. 07:00")
        self._f_beginn.setStyleSheet(self._field_style())
        fl.addRow("Beginn:", self._f_beginn)

        # Ende
        self._f_ende = QLineEdit()
        self._f_ende.setPlaceholderText("z.B. 19:00")
        self._f_ende.setStyleSheet(self._field_style())
        fl.addRow("Ende:", self._f_ende)

        # Patienten
        self._f_patienten = QSpinBox()
        self._f_patienten.setRange(0, 999)
        self._f_patienten.setStyleSheet(self._field_style())
        fl.addRow("Patienten:", self._f_patienten)

        # Ersteller
        self._f_ersteller = QLineEdit()
        self._f_ersteller.setPlaceholderText("Name Protokollersteller")
        self._f_ersteller.setStyleSheet(self._field_style())
        fl.addRow("Ersteller:", self._f_ersteller)

        # Abzeichner
        self._f_abzeichner = QLineEdit()
        self._f_abzeichner.setPlaceholderText("Name Abzeichner (bei Abschluss)")
        self._f_abzeichner.setStyleSheet(self._field_style())
        fl.addRow("Abzeichner:", self._f_abzeichner)

        layout.addLayout(fl)

        # Ereignisse / VorfÃ¤lle
        layout.addWidget(self._section_label("âš  Ereignisse / VorfÃ¤lle"))
        self._f_ereignisse = QTextEdit()
        self._f_ereignisse.setPlaceholderText("Besondere Ereignisse, VorfÃ¤lle, EinsÃ¤tze ...")
        self._f_ereignisse.setFixedHeight(110)
        self._f_ereignisse.setStyleSheet(self._textarea_style())
        layout.addWidget(self._f_ereignisse)

        # Fahrzeuge
        layout.addWidget(self._section_label("ğŸš— Fahrzeuge"))
        self._fahrzeug_section = QFrame()
        self._fahrzeug_section.setStyleSheet("QFrame { border: none; }")
        self._fahrzeug_section_layout = QVBoxLayout(self._fahrzeug_section)
        self._fahrzeug_section_layout.setContentsMargins(0, 0, 0, 0)
        self._fahrzeug_section_layout.setSpacing(4)
        _hint = QLabel("ğŸ‘ Fahrzeuge werden beim Ã–ffnen eines Protokolls geladen")
        _hint.setStyleSheet("color: #aaa; font-size: 10px; border: none;")
        self._fahrzeug_section_layout.addWidget(_hint)
        layout.addWidget(self._fahrzeug_section)

        # Handys
        layout.addWidget(self._section_label("ğŸ“± Handys"))
        self._handy_section = QFrame()
        self._handy_section.setStyleSheet("QFrame { border: none; }")
        self._handy_section_layout = QVBoxLayout(self._handy_section)
        self._handy_section_layout.setContentsMargins(0, 0, 0, 0)
        self._handy_section_layout.setSpacing(4)
        _handy_hint = QLabel("ğŸ‘ Noch keine GerÃ¤te eingetragen")
        _handy_hint.setStyleSheet("color: #aaa; font-size: 10px; border: none;")
        self._handy_section_layout.addWidget(_handy_hint)
        layout.addWidget(self._handy_section)
        self._btn_add_handy = QPushButton("â• GerÃ¤t hinzufÃ¼gen")
        self._btn_add_handy.setFixedHeight(28)
        self._btn_add_handy.setCursor(Qt.CursorShape.PointingHandCursor)
        self._btn_add_handy.setStyleSheet(
            "QPushButton{background:#eef4fa;border:1px solid #b0c8e8;"
            "border-radius:4px;padding:2px 10px;color:#0a6ed1;font-size:11px;}"
            "QPushButton:hover{background:#d0e4f5;}"
        )
        self._btn_add_handy.clicked.connect(self._add_handy_row)
        layout.addWidget(self._btn_add_handy)

        # Ãœbergabe-Notiz
        layout.addWidget(self._section_label("ğŸ“ Ãœbergabe-Notiz (fÃ¼r die Folgeschicht)"))
        self._f_notiz = QTextEdit()
        self._f_notiz.setPlaceholderText("Wichtige Informationen fÃ¼r die Folgeschicht ...")
        self._f_notiz.setFixedHeight(110)
        self._f_notiz.setStyleSheet(self._textarea_style())
        layout.addWidget(self._f_notiz)

        layout.addSpacing(8)

        # Buttons
        btn_row = QHBoxLayout()
        btn_row.setSpacing(10)

        self._btn_speichern = QPushButton("ğŸ’¾  Speichern")
        self._btn_speichern.setFont(QFont("Arial", 11, QFont.Weight.Bold))
        self._btn_speichern.setFixedHeight(40)
        self._btn_speichern.setCursor(Qt.CursorShape.PointingHandCursor)
        self._btn_speichern.setStyleSheet(f"""
            QPushButton {{
                background-color: {FIORI_BLUE};
                color: white; border: none;
                border-radius: 4px; padding: 4px 24px;
            }}
            QPushButton:hover {{ background-color: #0855a9; }}
            QPushButton:disabled {{ background-color: #ccc; color: #999; }}
        """)
        self._btn_speichern.clicked.connect(self._speichern)
        self._btn_speichern.setEnabled(False)

        self._btn_abschliessen = QPushButton("âœ“  AbschlieÃŸen")
        self._btn_abschliessen.setFont(QFont("Arial", 11))
        self._btn_abschliessen.setFixedHeight(40)
        self._btn_abschliessen.setCursor(Qt.CursorShape.PointingHandCursor)
        self._btn_abschliessen.setStyleSheet(f"""
            QPushButton {{
                background-color: {FIORI_SUCCESS};
                color: white; border: none;
                border-radius: 4px; padding: 4px 24px;
            }}
            QPushButton:hover {{ background-color: #0d6831; }}
            QPushButton:disabled {{ background-color: #ccc; color: #999; }}
        """)
        self._btn_abschliessen.clicked.connect(self._abschliessen)
        self._btn_abschliessen.setEnabled(False)

        self._btn_email = QPushButton("ğŸ“§  E-Mail")
        self._btn_email.setFont(QFont("Arial", 11))
        self._btn_email.setFixedHeight(40)
        self._btn_email.setCursor(Qt.CursorShape.PointingHandCursor)
        self._btn_email.setStyleSheet("""
            QPushButton {
                background-color: #0078a8;
                color: white; border: none;
                border-radius: 4px; padding: 4px 20px;
            }
            QPushButton:hover { background-color: #005f8a; }
            QPushButton:disabled { background-color: #ccc; color: #999; }
        """)
        self._btn_email.clicked.connect(self._email_erstellen)
        self._btn_email.setEnabled(False)

        self._btn_loeschen = QPushButton("ğŸ—‘  LÃ¶schen")
        self._btn_loeschen.setFont(QFont("Arial", 11))
        self._btn_loeschen.setFixedHeight(40)
        self._btn_loeschen.setCursor(Qt.CursorShape.PointingHandCursor)
        self._btn_loeschen.setStyleSheet(f"""
            QPushButton {{
                background-color: #e0e0e0;
                color: #555; border: none;
                border-radius: 4px; padding: 4px 18px;
            }}
            QPushButton:hover {{ background-color: #ffcccc; color: #a00; }}
            QPushButton:disabled {{ background-color: #eee; color: #bbb; }}
        """)
        self._btn_loeschen.clicked.connect(self._loeschen)
        self._btn_loeschen.setEnabled(False)

        btn_row.addWidget(self._btn_speichern)
        btn_row.addWidget(self._btn_abschliessen)
        btn_row.addWidget(self._btn_email)
        btn_row.addStretch()
        btn_row.addWidget(self._btn_loeschen)
        layout.addLayout(btn_row)
        layout.addStretch()

        scroll.setWidget(form_widget)
        outer.addWidget(scroll, 1)
        return self._form_container

    # â”€â”€ Hilfsmethoden â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    def _field_style(self) -> str:
        return (
            "border: 1px solid #ccc; border-radius: 3px; "
            "padding: 4px 8px; background: white; min-width: 240px;"
        )

    def _textarea_style(self) -> str:
        return (
            "border: 1px solid #ccc; border-radius: 3px; "
            "padding: 6px; background: white; font-size: 12px;"
        )

    def _section_label(self, text: str) -> QLabel:
        lbl = QLabel(text)
        lbl.setFont(QFont("Arial", 11, QFont.Weight.Bold))
        lbl.setStyleSheet(
            f"color: {FIORI_TEXT}; border-bottom: 1px solid #e0e0e0; "
            f"padding-bottom: 4px; margin-top: 6px;"
        )
        return lbl

    # â”€â”€ Liste laden â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    def _lade_liste(self):
        # Alte EintrÃ¤ge entfernen (ohne den Stretch am Ende)
        while self._liste_layout.count() > 1:
            item = self._liste_layout.takeAt(0)
            if item.widget():
                item.widget().deleteLater()

        self._update_nav_label()
        filter_idx = self._filter_combo.currentIndex()
        typ_filter = {0: None, 1: "tagdienst", 2: "nachtdienst"}.get(filter_idx)

        monat_str = f"{self._nav_jahr}-{self._nav_monat:02d}"
        protokolle = lade_protokolle(schicht_typ=typ_filter, monat=monat_str)

        self._list_items.clear()

        if not protokolle:
            lbl = QLabel("Keine Protokolle vorhanden")
            lbl.setStyleSheet("color: #999; padding: 16px; font-size: 12px; border: none;")
            lbl.setAlignment(Qt.AlignmentFlag.AlignCenter)
            self._liste_layout.insertWidget(0, lbl)
            return

        for p in protokolle:
            item = _ProtokolListItem(p)
            pid = p["id"]
            self._list_items[pid] = item
            item.mousePressEvent = lambda e, i=pid: self._item_clicked(i)
            # Bereits aktives Item sofort hervorheben
            if pid == self._aktives_protokoll_id:
                item.set_active(True)
            self._liste_layout.insertWidget(
                self._liste_layout.count() - 1,  # vor dem Stretch
                item
            )
        self._apply_protokoll_filter()

    def _apply_protokoll_filter(self):
        """Filtert die Protokollliste nach dem eingegebenen Suchtext."""
        text = self._ue_search.text().strip().lower()
        for pid, item in self._list_items.items():
            if not text:
                item.setVisible(True)
            else:
                item.setVisible(text in getattr(item, "_search_text", "").lower())

    # â”€â”€ Item-Auswahl â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    def _nav_prev_monat(self):
        if self._nav_monat == 1:
            self._nav_monat = 12
            self._nav_jahr -= 1
        else:
            self._nav_monat -= 1
        self._lade_liste()

    def _nav_next_monat(self):
        if self._nav_monat == 12:
            self._nav_monat = 1
            self._nav_jahr += 1
        else:
            self._nav_monat += 1
        self._lade_liste()

    def _update_nav_label(self):
        _MONATE = ["", "Januar", "Februar", "MÃ¤rz", "April", "Mai", "Juni",
                   "Juli", "August", "September", "Oktober", "November", "Dezember"]
        self._lbl_nav_monat.setText(
            f"{_MONATE[self._nav_monat]} {self._nav_jahr}"
        )
    def _item_clicked(self, protokoll_id: int):
        """Item in der Liste anklicken: altes deaktivieren, neues aktivieren."""
        for pid, itm in self._list_items.items():
            itm.set_active(pid == protokoll_id)
        self._lade_protokoll_in_form(protokoll_id)

    # â”€â”€ Formular befÃ¼llen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    def _lade_protokoll_in_form(self, protokoll_id: int):
        p = lade_protokoll_by_id(protokoll_id)
        if not p:
            return

        self._aktives_protokoll_id = protokoll_id
        # Hervorhebung synchron halten
        for pid, itm in self._list_items.items():
            itm.set_active(pid == protokoll_id)
        self._ist_neu = False
        self._aktueller_typ = p.get("schicht_typ", "tagdienst")

        typ_label = "â˜€ Tagdienst" if self._aktueller_typ == "tagdienst" else "ğŸŒ™ Nachtdienst"
        status = p.get("status", "offen")
        self._form_titel.setText(
            f"{typ_label}-Protokoll  â€“  ID #{protokoll_id}"
            + ("  [abgeschlossen]" if status == "abgeschlossen" else "")
        )
        farbe = _TAG_COLOR if self._aktueller_typ == "tagdienst" else _NACHT_COLOR
        self._form_header.setStyleSheet(
            f"background-color: {farbe}22; border-bottom: 1px solid {farbe};"
        )
        self._form_titel.setStyleSheet(f"color: {farbe};")

        # Felder setzen
        try:
            qd = QDate.fromString(p.get("datum", ""), "yyyy-MM-dd")
            if qd.isValid():
                self._f_datum.setDate(qd)
        except Exception:
            pass
        self._f_beginn.setText(p.get("beginn_zeit", ""))
        self._f_ende.setText(p.get("ende_zeit", ""))
        self._f_patienten.setValue(int(p.get("patienten_anzahl") or 0))
        self._f_ersteller.setText(p.get("ersteller", ""))
        self._f_abzeichner.setText(p.get("abzeichner", ""))
        self._f_ereignisse.setPlainText(p.get("ereignisse", ""))
        self._f_notiz.setPlainText(p.get("uebergabe_notiz", ""))
        self._rebuild_fahrzeug_section(protokoll_id)
        self._rebuild_handy_section(protokoll_id)

        abges = (status == "abgeschlossen")
        self._btn_speichern.setEnabled(not abges)
        self._btn_abschliessen.setEnabled(not abges)
        self._btn_loeschen.setEnabled(True)
        self._btn_email.setEnabled(True)

        for w in [self._f_datum, self._f_beginn, self._f_ende,
                  self._f_patienten, self._f_ersteller, self._f_abzeichner,
                  self._f_ereignisse, self._f_notiz, self._btn_add_handy]:
            w.setEnabled(not abges)
        for w in self._fahrzeug_notiz_widgets.values():
            w.setEnabled(not abges)
        for nr, notiz in self._handy_eintraege_widgets:
            nr.setEnabled(not abges)
            notiz.setEnabled(not abges)

    def _neues_protokoll(self, typ: str):
        """Ã–ffnet ein leeres Formular fÃ¼r ein neues Protokoll."""
        self._aktives_protokoll_id = None
        self._ist_neu = True
        self._aktueller_typ = typ

        farbe = _TAG_COLOR if typ == "tagdienst" else _NACHT_COLOR
        typ_label = "â˜€ Tagdienst" if typ == "tagdienst" else "ğŸŒ™ Nachtdienst"
        self._form_titel.setText(f"Neues {typ_label}-Protokoll")
        self._form_header.setStyleSheet(
            f"background-color: {farbe}22; border-bottom: 1px solid {farbe};"
        )
        self._form_titel.setStyleSheet(f"color: {farbe};")

        # Felder leeren + Zeiten je nach Diensttyp vorbelegen
        self._f_datum.setDate(QDate.currentDate())
        if typ == "tagdienst":
            self._f_beginn.setText("07:00")
            self._f_ende.setText("19:00")
        else:
            self._f_beginn.setText("19:00")
            self._f_ende.setText("07:00")
        self._f_patienten.setValue(0)
        self._f_ersteller.setText("")
        self._f_abzeichner.setText("")
        self._f_ereignisse.clear()
        self._f_notiz.clear()
        self._rebuild_fahrzeug_section(None)
        self._rebuild_handy_section(None)

        for w in [self._f_datum, self._f_beginn, self._f_ende,
                  self._f_patienten, self._f_ersteller, self._f_abzeichner,
                  self._f_ereignisse, self._f_notiz, self._btn_add_handy]:
            w.setEnabled(True)
        for w in self._fahrzeug_notiz_widgets.values():
            w.setEnabled(True)

        self._btn_speichern.setEnabled(True)
        self._btn_abschliessen.setEnabled(False)
        self._btn_loeschen.setEnabled(False)
        self._btn_email.setEnabled(False)

    # â”€â”€ Aktionen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    def _speichern(self):
        datum_str = self._f_datum.date().toString("yyyy-MM-dd")

        kwargs = dict(
            beginn_zeit      = self._f_beginn.text().strip(),
            ende_zeit        = self._f_ende.text().strip(),
            patienten_anzahl = self._f_patienten.value(),
            ereignisse       = self._f_ereignisse.toPlainText().strip(),
            uebergabe_notiz  = self._f_notiz.toPlainText().strip(),
            ersteller        = self._f_ersteller.text().strip(),
        )

        try:
            if self._ist_neu:
                new_id = erstelle_protokoll(
                    datum=datum_str,
                    schicht_typ=self._aktueller_typ,
                    **kwargs
                )
                self._aktives_protokoll_id = new_id
                self._ist_neu = False
                self._btn_abschliessen.setEnabled(True)
                self._btn_loeschen.setEnabled(True)
                self._btn_email.setEnabled(True)
                QMessageBox.information(
                    self, "Gespeichert",
                    f"Protokoll #{new_id} wurde erfolgreich gespeichert."
                )
            else:
                aktualisiere_protokoll(
                    protokoll_id=self._aktives_protokoll_id,
                    abzeichner=self._f_abzeichner.text().strip(),
                    status="offen",
                    **kwargs
                )
                QMessageBox.information(
                    self, "Gespeichert",
                    f"Protokoll #{self._aktives_protokoll_id} wurde aktualisiert."
                )
        except Exception as e:
            QMessageBox.critical(self, "Fehler", f"Speichern fehlgeschlagen:\n{e}")
            return

        self._lade_liste()
        # Notizen + Handy-EintrÃ¤ge speichern
        if self._aktives_protokoll_id:
            notizen_fz = {
                fid: w.text().strip()
                for fid, w in self._fahrzeug_notiz_widgets.items()
            }
            speichere_fahrzeug_notizen(self._aktives_protokoll_id, notizen_fz)
            eintraege_handy = [
                (nr.text().strip(), notiz.text().strip())
                for nr, notiz in self._handy_eintraege_widgets
                if nr.text().strip()
            ]
            speichere_handy_eintraege(self._aktives_protokoll_id, eintraege_handy)

    def _abschliessen(self):
        if self._aktives_protokoll_id is None:
            return
        abzeichner = self._f_abzeichner.text().strip()
        if not abzeichner:
            QMessageBox.warning(self, "Kein Abzeichner",
                                "Bitte trage einen Abzeichner ein, bevor du das Protokoll abschlieÃŸt.")
            return

        antwort = QMessageBox.question(
            self, "Protokoll abschlieÃŸen",
            f"Protokoll #{self._aktives_protokoll_id} als abgeschlossen markieren?\n\n"
            f"Abzeichner: {abzeichner}\n\nDanach ist das Protokoll schreibgeschÃ¼tzt.",
            QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No
        )
        if antwort != QMessageBox.StandardButton.Yes:
            return

        # Zuerst aktuelle Ã„nderungen speichern
        self._speichern()

        schliesse_protokoll_ab(self._aktives_protokoll_id, abzeichner)
        self._lade_protokoll_in_form(self._aktives_protokoll_id)
        self._lade_liste()

    def _loeschen(self):
        if self._aktives_protokoll_id is None:
            return
        antwort = QMessageBox.question(
            self, "Protokoll lÃ¶schen",
            f"Protokoll #{self._aktives_protokoll_id} dauerhaft lÃ¶schen?",
            QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No
        )
        if antwort != QMessageBox.StandardButton.Yes:
            return
        loesche_protokoll(self._aktives_protokoll_id)
        self._aktives_protokoll_id = None
        self._ist_neu = False
        self._form_titel.setText("Protokoll auswÃ¤hlen oder neu erstellen")
        self._form_header.setStyleSheet(
            f"background-color: #eef4fa; border-bottom: 1px solid {FIORI_BORDER};"
        )
        self._form_titel.setStyleSheet(f"color: {FIORI_TEXT};")
        self._btn_speichern.setEnabled(False)
        self._btn_abschliessen.setEnabled(False)
        self._btn_loeschen.setEnabled(False)
        self._lade_liste()

    # â”€â”€ Fahrzeug-Sektion dynamisch aufbauen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    def _rebuild_fahrzeug_section(self, protokoll_id):
        """Baut die Fahrzeug-Liste im Formular neu auf."""
        # Alte Widgets entfernen
        while self._fahrzeug_section_layout.count():
            item = self._fahrzeug_section_layout.takeAt(0)
            if item.widget():
                item.widget().deleteLater()
        self._fahrzeug_notiz_widgets.clear()

        fahrzeuge = lade_alle_fahrzeuge(nur_aktive=True)
        if not fahrzeuge:
            lbl = QLabel("Keine aktiven Fahrzeuge vorhanden")
            lbl.setStyleSheet("color:#aaa;font-size:10px;border:none;")
            self._fahrzeug_section_layout.addWidget(lbl)
            return

        existing = lade_fahrzeug_notizen(protokoll_id) if protokoll_id else {}

        _STAT_LABELS = {
            "fahrbereit":   "âœ… Fahrbereit",
            "defekt":        "âŒ Defekt",
            "werkstatt":     "ğŸ”§ Werkstatt",
            "ausser_dienst": "â›” AuÃŸer Dienst",
            "sonstiges":     "â„¹ Sonstiges",
        }
        _STAT_COLORS = {
            "fahrbereit":   "#2e7d32",
            "defekt":        "#c62828",
            "werkstatt":     "#e65100",
            "ausser_dienst": "#616161",
            "sonstiges":     "#1565c0",
        }

        for f in fahrzeuge:
            fid  = f["id"]
            kz   = f.get("kennzeichen", "?")
            typ  = f.get("typ", "")

            stat     = aktueller_fahrzeug_status(fid)
            stat_key = (stat.get("status", "fahrbereit") if stat else "fahrbereit")
            stat_lbl = _STAT_LABELS.get(stat_key, stat_key)
            stat_col = _STAT_COLORS.get(stat_key, "#555")

            termine       = lade_fahrzeug_termine(fid)
            offene_termin = [t for t in termine if not t.get("erledigt")]

            frame = QFrame()
            frame.setStyleSheet(
                "QFrame{background:#fafafa;border:1px solid #e0e0e0;border-radius:4px;}"
            )
            fl = QVBoxLayout(frame)
            fl.setContentsMargins(8, 6, 8, 6)
            fl.setSpacing(3)

            # Zeile 1: Kennzeichen | Typ | Status
            top = QHBoxLayout()
            kz_w = QLabel(f"<b>{kz}</b>")
            kz_w.setStyleSheet("border:none;color:#333;")
            typ_w = QLabel(typ)
            typ_w.setStyleSheet("border:none;color:#777;font-size:10px;")
            st_w = QLabel(stat_lbl)
            st_w.setStyleSheet(
                f"border:none;color:{stat_col};font-size:10px;font-weight:bold;"
            )
            top.addWidget(kz_w)
            top.addSpacing(6)
            top.addWidget(typ_w)
            top.addStretch()
            top.addWidget(st_w)
            fl.addLayout(top)

            # Zeile 2: nÃ¤chster offener Termin
            if offene_termin:
                t = offene_termin[0]
                t_lbl = QLabel(
                    f"ğŸ“… {t.get('datum','')}  {t.get('titel','')}"
                )
                t_lbl.setStyleSheet(
                    "border:none;color:#e65100;font-size:10px;"
                )
                fl.addWidget(t_lbl)

            # Zeile 3: Notiz-Eingabe
            nr = QHBoxLayout()
            nl = QLabel("Notiz:")
            nl.setStyleSheet("border:none;color:#555;font-size:10px;")
            nl.setFixedWidth(42)
            ne = QLineEdit()
            ne.setPlaceholderText(f"Notiz zu {kz} ...")
            ne.setStyleSheet(
                "border:1px solid #ccc;border-radius:3px;"
                "padding:2px 6px;font-size:11px;background:white;"
            )
            ne.setText(existing.get(fid, ""))
            nr.addWidget(nl)
            nr.addWidget(ne)
            fl.addLayout(nr)

            self._fahrzeug_notiz_widgets[fid] = ne
            self._fahrzeug_section_layout.addWidget(frame)

    # â”€â”€ E-Mail Dialog â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    def _email_erstellen(self):
        """Ã–ffnet einen Dialog zum Erstellen einer Ãœbergabe-E-Mail in Outlook."""
        from PySide6.QtWidgets import QCheckBox, QScrollArea as _QSA

        # â”€â”€ Protokoll-Daten â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        typ_label  = "Tagdienst â˜€" if self._aktueller_typ == "tagdienst" else "Nachtdienst ğŸŒ™"
        datum      = self._f_datum.date().toString("dd.MM.yyyy")
        beginn     = self._f_beginn.text().strip()
        ende       = self._f_ende.text().strip()
        ersteller  = self._f_ersteller.text().strip()
        abzeichner = self._f_abzeichner.text().strip()
        patienten  = self._f_patienten.value()
        ereignisse = self._f_ereignisse.toPlainText().strip()
        ue_notiz   = self._f_notiz.toPlainText().strip()
        pid        = self._aktives_protokoll_id

        betreff = (
            f"Ãœbergabeprotokoll #{pid} â€“ {typ_label} â€“ {datum}"
            if pid else
            f"Ãœbergabeprotokoll â€“ {typ_label} â€“ {datum}"
        )

        # â”€â”€ Fahrzeugstatus â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        _STAT_LABELS = {
            "fahrbereit":    "âœ… Fahrbereit",
            "defekt":        "âŒ Defekt",
            "werkstatt":     "ğŸ”§ Werkstatt",
            "ausser_dienst": "â›” AuÃŸer Dienst",
            "sonstiges":     "â„¹ Sonstiges",
        }
        try:
            alle_fz = lade_alle_fahrzeuge(nur_aktive=True)
            fz_map  = {f["id"]: f for f in lade_alle_fahrzeuge()}
        except Exception:
            alle_fz = []
            fz_map  = {}

        nicht_fb: list[tuple] = []
        for fz in alle_fz:
            fid  = fz["id"]
            stat = aktueller_fahrzeug_status(fid)
            sk   = stat.get("status", "fahrbereit") if stat else "fahrbereit"
            if sk != "fahrbereit":
                nicht_fb.append((fz.get("kennzeichen", "?"), sk,
                                  stat.get("grund", "") if stat else ""))

        # â”€â”€ SchÃ¤den letzte 7 Tage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        try:
            all_schaeden = lade_schaeden_letzte_tage(7)
        except Exception:
            all_schaeden = []

        offene_schaeden  = [s for s in all_schaeden if not s.get("gesendet")]
        bereits_gesendet = [s for s in all_schaeden if s.get("gesendet")]

        # â”€â”€ E-Mail Body aufbauen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        lines: list[str] = [
            f"Ãœbergabeprotokoll â€“ {typ_label}",
            "=" * 45,
            f"Datum:      {datum}",
            f"Schicht:    {beginn} â€“ {ende}",
            f"Ersteller:  {ersteller}" + (f"   |   Abzeichner: {abzeichner}" if abzeichner else ""),
            f"Patienten:  {patienten}",
            "",
        ]
        if ereignisse:
            lines += ["Ereignisse / VorfÃ¤lle:", ereignisse, ""]

        if alle_fz:
            lines.append("Fahrzeuge:")
            for fz in alle_fz:
                fid   = fz["id"]
                kz    = fz.get("kennzeichen", "?")
                stat  = aktueller_fahrzeug_status(fid)
                sk    = stat.get("status", "fahrbereit") if stat else "fahrbereit"
                slbl  = _STAT_LABELS.get(sk, sk)
                ne    = self._fahrzeug_notiz_widgets.get(fid)
                notiz = ne.text().strip() if ne else ""
                hint  = f" [{slbl}]" if sk != "fahrbereit" else ""
                grund = f" â€“ {stat['grund']}" if (sk != "fahrbereit" and stat and stat.get("grund")) else ""
                lines.append(f"  â€¢ {kz}{hint}{grund}" + (f": {notiz}" if notiz else ""))
            if nicht_fb:
                lines.append("")
                lines.append("âš  ACHTUNG â€“ Nicht fahrbereite Fahrzeuge:")
                for kz, sk, grund in nicht_fb:
                    lines.append(f"  â€¢ {kz}: {_STAT_LABELS.get(sk, sk)}"
                                  + (f" ({grund})" if grund else ""))
            lines.append("")

        handy_rows = [
            (nr.text().strip(), nt.text().strip())
            for nr, nt in self._handy_eintraege_widgets
            if nr.text().strip()
        ]
        if handy_rows:
            lines.append("Handys / GerÃ¤te:")
            for nr_t, nt_t in handy_rows:
                lines.append(f"  â€¢ GerÃ¤t {nr_t}" + (f": {nt_t}" if nt_t else ""))
            lines.append("")

        if ue_notiz:
            lines += ["Ãœbergabe-Notiz fÃ¼r die Folgeschicht:", ue_notiz, ""]

        body_pre = "\n".join(lines)

        # â”€â”€ Dialog â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        dlg = QDialog(self)
        dlg.setWindowTitle("ğŸ“§ E-Mail erstellen â€“ Ãœbergabeprotokoll")
        dlg.setMinimumWidth(660)
        dlg.setMinimumHeight(680)
        dlg_layout = QVBoxLayout(dlg)
        dlg_layout.setSpacing(10)
        dlg_layout.setContentsMargins(16, 14, 16, 14)

        # Adressfelder
        addr_form = QFormLayout()
        addr_form.setLabelAlignment(Qt.AlignmentFlag.AlignRight)
        addr_form.setSpacing(8)
        an_edit = QLineEdit()
        an_edit.setPlaceholderText("E-Mail-Adresse(n), kommagetrennt")
        addr_form.addRow("An:", an_edit)
        cc_edit = QLineEdit()
        cc_edit.setPlaceholderText("CC â€“ optional, kommagetrennt")
        addr_form.addRow("CC:", cc_edit)
        subj_edit = QLineEdit()
        subj_edit.setText(betreff)
        addr_form.addRow("Betreff:", subj_edit)
        dlg_layout.addLayout(addr_form)

        # â”€â”€ FahrzeugschÃ¤den-Sektion â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        schaden_frame = QFrame()
        schaden_frame.setStyleSheet(
            "QFrame{border:1px solid #e0a060;border-radius:5px;background:#fffdf8;}"
        )
        schaden_vl = QVBoxLayout(schaden_frame)
        schaden_vl.setContentsMargins(10, 8, 10, 8)
        schaden_vl.setSpacing(4)

        anz_offen = len(offene_schaeden)
        anz_ges   = len(bereits_gesendet)
        sch_lbl   = QLabel(
            f"ğŸ”§ FahrzeugschÃ¤den letzte 7 Tage  â€”  "
            f"{anz_offen} offen / ungesendet    {anz_ges} bereits gesendet"
        )
        sch_lbl.setStyleSheet("font-weight:bold;font-size:11px;border:none;")
        schaden_vl.addWidget(sch_lbl)

        sch_scroll = _QSA()
        sch_scroll.setWidgetResizable(True)
        sch_scroll.setMaximumHeight(130)
        sch_scroll.setStyleSheet("QScrollArea{border:none;}")
        sch_inner = QWidget()
        sch_inner.setStyleSheet("background:transparent;")
        sch_inner_vl = QVBoxLayout(sch_inner)
        sch_inner_vl.setContentsMargins(0, 0, 0, 0)
        sch_inner_vl.setSpacing(2)

        _SCHWERE_ICON = {"gering": "ğŸŸ¡", "mittel": "ğŸŸ ", "schwer": "ğŸ”´"}
        _schaden_checkboxes: list[tuple[QCheckBox, dict]] = []

        for s in offene_schaeden:
            icon = _SCHWERE_ICON.get(s.get("schwere", "gering"), "ğŸŸ¡")
            cb = QCheckBox(
                f"{icon} {s.get('kennzeichen','?')}  |  {s.get('datum','')}  |  "
                f"{s.get('beschreibung','')}"
            )
            cb.setChecked(True)
            cb.setStyleSheet("font-size:10px;")
            sch_inner_vl.addWidget(cb)
            _schaden_checkboxes.append((cb, s))

        for s in bereits_gesendet:
            cb = QCheckBox(
                f"âœ… {s.get('kennzeichen','?')}  |  {s.get('datum','')}  |  "
                f"{s.get('beschreibung','')}  [bereits gesendet]"
            )
            cb.setChecked(False)
            cb.setEnabled(False)
            cb.setStyleSheet("font-size:10px;color:#aaa;")
            sch_inner_vl.addWidget(cb)

        if not all_schaeden:
            no_lbl = QLabel("Keine SchÃ¤den in den letzten 7 Tagen erfasst.")
            no_lbl.setStyleSheet("color:#aaa;font-size:10px;border:none;padding:4px;")
            sch_inner_vl.addWidget(no_lbl)

        sch_scroll.setWidget(sch_inner)
        schaden_vl.addWidget(sch_scroll)
        dlg_layout.addWidget(schaden_frame)

        # E-Mail-Body
        body_lbl = QLabel("Nachricht:")
        body_lbl.setStyleSheet("font-weight:bold;")
        dlg_layout.addWidget(body_lbl)
        body_edit = QTextEdit()
        body_edit.setPlainText(body_pre)
        body_edit.setMinimumHeight(170)
        dlg_layout.addWidget(body_edit)

        # AnhÃ¤nge
        att_lbl = QLabel("AnhÃ¤nge:")
        att_lbl.setStyleSheet("font-weight:bold;")
        dlg_layout.addWidget(att_lbl)
        att_list = QListWidget()
        att_list.setMaximumHeight(70)
        att_list.setStyleSheet(
            "QListWidget{border:1px solid #ccc;border-radius:3px;font-size:10px;}"
        )
        dlg_layout.addWidget(att_list)

        att_row = QHBoxLayout()
        att_add_btn = QPushButton("â• Datei hinzufÃ¼gen")
        att_add_btn.setFixedHeight(26)
        att_add_btn.setStyleSheet(
            "QPushButton{background:#eef4fa;border:1px solid #b0c8e8;"
            "border-radius:4px;padding:2px 10px;color:#0a6ed1;font-size:11px;}"
            "QPushButton:hover{background:#d0e4f5;}"
        )
        att_remove_btn = QPushButton("âœ• Entfernen")
        att_remove_btn.setFixedHeight(26)
        att_remove_btn.setStyleSheet(
            "QPushButton{background:#eee;border:1px solid #ccc;"
            "border-radius:4px;padding:2px 10px;font-size:11px;}"
            "QPushButton:hover{background:#ffcccc;color:#a00;}"
        )
        att_row.addWidget(att_add_btn)
        att_row.addWidget(att_remove_btn)
        att_row.addStretch()
        dlg_layout.addLayout(att_row)

        def _add_att():
            paths, _ = QFileDialog.getOpenFileNames(dlg, "Datei(en) auswÃ¤hlen")
            for p in paths:
                if p:
                    att_list.addItem(p)

        def _remove_att():
            for it in att_list.selectedItems():
                att_list.takeItem(att_list.row(it))

        att_add_btn.clicked.connect(_add_att)
        att_remove_btn.clicked.connect(_remove_att)

        # Buttons
        btn_box = QDialogButtonBox()
        send_btn   = btn_box.addButton("ğŸ“§ In Outlook Ã¶ffnen", QDialogButtonBox.ButtonRole.AcceptRole)
        cancel_btn = btn_box.addButton("Abbrechen",            QDialogButtonBox.ButtonRole.RejectRole)  # noqa
        btn_box.rejected.connect(dlg.reject)
        send_btn.setStyleSheet(
            "QPushButton{background:#0078a8;color:white;border:none;border-radius:4px;"
            "padding:6px 18px;font-weight:bold;}"
            "QPushButton:hover{background:#005f8a;}"
        )
        dlg_layout.addWidget(btn_box)

        def _senden():
            from functions.mail_functions import create_outlook_draft

            checked   = [(cb, s) for cb, s in _schaden_checkboxes if cb.isChecked()]
            unchecked = [(cb, s) for cb, s in _schaden_checkboxes if not cb.isChecked()]

            # Warnung wenn offene SchÃ¤den NICHT mitgesendet werden
            if unchecked:
                answer = QMessageBox.warning(
                    dlg,
                    "Offene SchÃ¤den nicht mitgesendet",
                    f"Es gibt {len(unchecked)} offene SchÃ¤den, die du NICHT in die E-Mail aufnimmst.\n\n"
                    "Trotzdem senden?",
                    QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No,
                    QMessageBox.StandardButton.No,
                )
                if answer != QMessageBox.StandardButton.Yes:
                    return

            body_text = body_edit.toPlainText().strip()

            # AusgewÃ¤hlte SchÃ¤den in den Body einbauen
            if checked:
                sch_lines = ["", "â”€" * 38, "ğŸ”§ Gemeldete FahrzeugschÃ¤den:", "â”€" * 38]
                for _, s in checked:
                    icon = _SCHWERE_ICON.get(s.get("schwere", "gering"), "ğŸŸ¡")
                    behoben_txt = " [behoben]" if s.get("behoben") else " [âš  offen]"
                    sch_lines.append(
                        f"  {icon} {s.get('kennzeichen','?')}  |  {s.get('datum','')}  |  "
                        f"{s.get('beschreibung','')}{behoben_txt}"
                        + (f"\n       Kommentar: {s['kommentar']}" if s.get("kommentar") else "")
                    )
                body_text += "\n" + "\n".join(sch_lines)

            to_val = an_edit.text().strip()
            cc_val = cc_edit.text().strip()
            subj   = subj_edit.text().strip()
            atts   = [att_list.item(i).text() for i in range(att_list.count())]
            try:
                create_outlook_draft(
                    to=to_val,
                    subject=subj,
                    body_text=body_text,
                    cc=cc_val,
                    attachments=atts if atts else None,
                )
                # Als gesendet markieren
                for _, s in checked:
                    try:
                        markiere_schaden_gesendet(s["id"])
                    except Exception:
                        pass
                dlg.accept()
            except Exception as e:
                QMessageBox.critical(
                    dlg, "Fehler",
                    f"E-Mail konnte nicht erstellt werden:\n{e}\n\n"
                    "Bitte sicherstellen, dass Outlook geÃ¶ffnet ist."
                )

        send_btn.clicked.connect(_senden)
        dlg.exec()

    # â”€â”€ Handy-Sektion dynamisch aufbauen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    def _rebuild_handy_section(self, protokoll_id):
        """Baut die Handy-Eintragsliste neu auf."""
        while self._handy_section_layout.count():
            item = self._handy_section_layout.takeAt(0)
            if item.widget():
                item.widget().deleteLater()
        self._handy_eintraege_widgets.clear()

        eintraege = lade_handy_eintraege(protokoll_id) if protokoll_id else []
        if eintraege:
            for e in eintraege:
                self._add_handy_row(
                    geraet_nr=e["geraet_nr"] if isinstance(e, dict) else e[0],
                    notiz=e["notiz"] if isinstance(e, dict) else e[1],
                    _skip_hint_remove=True
                )
        else:
            hint = QLabel("ğŸ¤™ Noch keine GerÃ¤te eingetragen â€“ â• hinzufÃ¼gen")
            hint.setStyleSheet("color: #aaa; font-size: 10px; border: none;")
            self._handy_section_layout.addWidget(hint)

    def _add_handy_row(self, geraet_nr: str = "", notiz: str = "",
                       _skip_hint_remove: bool = False):
        """FÃ¼gt eine neue Zeile (GerÃ¤te-Nr + Notiz) zur Handy-Sektion hinzu."""
        if not _skip_hint_remove and self._handy_section_layout.count() > 0:
            first = self._handy_section_layout.itemAt(0)
            if first and first.widget() and isinstance(first.widget(), QLabel):
                w = self._handy_section_layout.takeAt(0).widget()
                w.deleteLater()

        row_frame = QFrame()
        row_frame.setStyleSheet(
            "QFrame{background:#fafafa;border:1px solid #e8e8e8;border-radius:4px;}"
        )
        row_layout = QHBoxLayout(row_frame)
        row_layout.setContentsMargins(6, 4, 6, 4)
        row_layout.setSpacing(6)

        nr_lbl = QLabel("GerÃ¤t:")
        nr_lbl.setStyleSheet("border:none;color:#555;font-size:10px;")
        nr_lbl.setFixedWidth(40)
        nr_edit = QLineEdit()
        nr_edit.setPlaceholderText("z.B. 7 oder Handy-3")
        nr_edit.setText(str(geraet_nr))
        nr_edit.setFixedWidth(100)
        nr_edit.setStyleSheet(
            "border:1px solid #ccc;border-radius:3px;padding:2px 4px;"
            "font-size:11px;background:white;"
        )

        notiz_edit = QLineEdit()
        notiz_edit.setPlaceholderText("Notiz zu diesem GerÃ¤t ...")
        notiz_edit.setText(str(notiz))
        notiz_edit.setStyleSheet(
            "border:1px solid #ccc;border-radius:3px;padding:2px 4px;"
            "font-size:11px;background:white;"
        )

        del_btn = QPushButton("âœ•")
        del_btn.setFixedSize(22, 22)
        del_btn.setStyleSheet(
            "QPushButton{background:#eee;border:none;border-radius:3px;"
            "color:#a00;font-weight:bold;font-size:11px;}"
            "QPushButton:hover{background:#ffcccc;}"
        )

        row_layout.addWidget(nr_lbl)
        row_layout.addWidget(nr_edit)
        row_layout.addWidget(notiz_edit, 1)
        row_layout.addWidget(del_btn)

        entry = (nr_edit, notiz_edit)
        self._handy_eintraege_widgets.append(entry)

        def _remove():
            if entry in self._handy_eintraege_widgets:
                self._handy_eintraege_widgets.remove(entry)
            row_frame.setParent(None)
            row_frame.deleteLater()
            if self._handy_section_layout.count() == 0:
                hint = QLabel("ğŸ¤™ Noch keine GerÃ¤te eingetragen â€“ â• hinzufÃ¼gen")
                hint.setStyleSheet("color: #aaa; font-size: 10px; border: none;")
                self._handy_section_layout.addWidget(hint)

        del_btn.clicked.connect(_remove)
        self._handy_section_layout.addWidget(row_frame)

    # â”€â”€ Refresh (von main_window aufgerufen) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    def refresh(self):
        self._lade_liste()
